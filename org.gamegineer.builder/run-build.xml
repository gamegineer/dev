<?xml version="1.0" encoding="UTF-8"?>
<!--
    run-build.xml
    Copyright 2008-2013 Gamegineer.org
    All rights reserved.

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

    Created on Mar 15, 2008 at 9:53:00 PM.
-->
<project name="gamegineer" default="build" basedir="." xmlns:antcontrib="antlib:net.sf.antcontrib">

    <property environment="env" />
    <property file="run-build.properties" />

    <!-- Set up references to external tools -->
    <property name="ant-contrib-home" value="${env.ANT_CONTRIB_LATEST_HOME}" />

    <!-- Set up references to PDE Build scripts -->
    <path id="eclipse.pdebuild.scripts.path">
        <dirset dir="${env.ECLIPSE_HOME}/plugins">
            <include name="org.eclipse.pde.build_*/scripts" />
        </dirset>
    </path>
    <property name="eclipse.pdebuild.scripts" refid="eclipse.pdebuild.scripts.path" />

    <!-- Import external Ant libraries -->
    <typedef resource="net/sf/antcontrib/antlib.xml" uri="antlib:net.sf.antcontrib">
        <classpath>
            <pathelement location="${ant-contrib-home}/ant-contrib.jar" />
        </classpath>
    </typedef>

    <!-- Generate version qualifier -->
    <tstamp>
        <format pattern="yyyyMMdd-HHmm" property="version.qualifier.timestamp" timezone="UTC" />
    </tstamp>
    <antcontrib:if>
        <length string="${version.qualifier.prefix}" when="gt" length="0" />
        <antcontrib:then>
            <property name="version.qualifier" value="${version.qualifier.prefix}-v${version.qualifier.timestamp}" />
            <property name="build.version" value="${version.number}.${version.qualifier.prefix}" />
        </antcontrib:then>
        <antcontrib:else>
            <property name="version.qualifier" value="v${version.qualifier.timestamp}" />
            <property name="build.version" value="${version.number}" />
        </antcontrib:else>
    </antcontrib:if>

    <!--
        Builds the entire Gamegineer workspace.

        This target should be run from the org.gamegineer.builder directory
        and assumes the environment has been set up appropriately according
        to the Gamegineer build system guidelines.
    -->
    <target name="build">
        <antcall target="before-build" />
        <antcall target="core-build" />
        <antcall target="after-build" />
    </target>

    <target name="before-build">
        <!-- Update product verison -->
        <replace
                file="product/configuration/org.eclipse.equinox.simpleconfigurator/bundles.info"
                token="%version"
                value="${version.number}" />

        <!-- Update version qualifiers not managed by PDE Build -->
        <replace
                file="product/configuration/org.eclipse.equinox.simpleconfigurator/bundles.info"
                token="%qualifier"
                value="${version.qualifier}" />
    </target>

    <target name="core-build">
        <java
                classname="org.eclipse.core.launcher.Main"
                failonerror="true"
                fork="true"
                maxmemory="256m">
            <classpath>
                <fileset dir="${env.ECLIPSE_HOME}/plugins">
                    <include name="org.eclipse.equinox.launcher_*.jar" />
                </fileset>
            </classpath>
            <jvmarg value="-Dbasearch=${env.BUILD_ARCH}" />
            <jvmarg value="-Dbaseos=${env.BUILD_OS}" />
            <jvmarg value="-Dbasews=${env.BUILD_WS}" />
            <jvmarg value="-DbuildDirectory=${basedir}" />
            <jvmarg value="-DbuildVersion=${build.version}" />
            <jvmarg value="-DforceContextQualifier=${version.qualifier}" />
            <jvmarg value="-Djava-help-home=${java-help-home}" />
            <jvmarg value="-DJavaSE-1.6=${env.JAVA_HOME}/jre/lib/rt.jar:${env.JAVA_HOME}/jre/lib/jce.jar" />
            <arg value="-application" />
            <arg value="org.eclipse.ant.core.antRunner" />
            <arg value="-buildfile" />
            <arg value="${eclipse.pdebuild.scripts}/build.xml" />
        </java>
    </target>

    <target name="after-build">
    </target>

</project>
