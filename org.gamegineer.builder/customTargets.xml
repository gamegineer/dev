<?xml version="1.0" encoding="UTF-8"?>
<!--
    customTargets.xml
    Copyright 2008-2013 Gamegineer contributors and others.
    All rights reserved.

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

    Created on Mar 15, 2008 at 9:53:00 PM.
-->
<project name="customTargets.template" default="noDefault">

    <!-- ===================================================================== -->
    <!-- Run a given ${target} on all elements being built. -->
    <!-- Add on <ant> task for each top level element being built. -->
    <!-- ===================================================================== -->
    <available property="allElementsFile" file="${builder}/allElements.xml" value="${builder}/allElements.xml" />
    <property name="allElementsFile" location="${eclipse.pdebuild.templates}/headless-build/allElements.xml" />

    <import file="${allElementsFile}" />
    <target name="allElements">
        <antcall target="allElementsDelegator" />
    </target>

    <!-- ===================================================================== -->
    <!-- ===================================================================== -->
    <target name="getBaseComponents" depends="checkLocalBase" unless="skipBase">
        <get src="${eclipseBaseURL}" dest="${buildDirectory}/../temp-base.zip" />
        <unzip dest="${base}" overwrite="true" src="${buildDirectory}/../temp-base.zip" />
    </target>

    <target name="checkLocalBase">
        <available file="${base}" property="skipBase" />
    </target>

    <!-- ===================================================================== -->
    <!-- Check out map files from correct repository. -->
    <!-- Replace values for mapsCheckoutTag as desired. -->
    <!-- ===================================================================== -->
    <target name="getMapFiles" depends="checkLocalMaps" unless="skipMaps">
        <property name="mapsCheckoutTag" value="HEAD" />
        <cvs cvsRoot="${mapsRepo}" package="${mapsRoot}" dest="${buildDirectory}/maps" tag="${mapsCheckoutTag}" />
    </target>

    <target name="checkLocalMaps">
        <available property="skipMaps" file="${buildDirectory}/maps" />
    </target>

    <target name="tagMapFiles" if="tagMaps">
        <cvs dest="${buildDirectory}/maps/${mapsRoot}" command="tag ${mapsTagTag}" />
    </target>

    <!-- ===================================================================== -->

    <target name="clean" unless="noclean">
        <antcall target="allElements">
            <param name="target" value="cleanElement" />
        </antcall>
    </target>

    <target name="gatherLogs">
        <mkdir dir="${buildDirectory}/${buildLabel}/compilelogs" />
        <antcall target="allElements">
            <param name="target" value="gatherLogs" />
        </antcall>
        <unzip dest="${buildDirectory}/${buildLabel}/compilelogs" overwrite="true">
            <fileset dir="${buildDirectory}/features">
                <include name="**/*.log.zip" />
            </fileset>
        </unzip>
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do before setup. -->
    <!-- ===================================================================== -->
    <target name="preSetup">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do after setup but before starting the build proper. -->
    <!-- ===================================================================== -->
    <target name="postSetup">
        <antcall target="getBaseComponents" />
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do before fetching the build elements. -->
    <!-- ===================================================================== -->
    <target name="preFetch">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do after fetching the build elements. -->
    <!-- ===================================================================== -->
    <target name="postFetch">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do before the repositories are being processed. -->
    <!-- ===================================================================== -->
    <target name="preProcessRepos">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do after the repositories have been processed. -->
    <!-- ===================================================================== -->
    <target name="postProcessRepos">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do before generating the build scripts. -->
    <!-- ===================================================================== -->
    <target name="preGenerate">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do after generating the build scripts. -->
    <!-- ===================================================================== -->
    <target name="postGenerate">
        <antcall target="clean" />
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do before running the build.xmls for the elements being built. -->
    <!-- ===================================================================== -->
    <target name="preProcess">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do after running the build.xmls for the elements being built. -->
    <!-- ===================================================================== -->
    <target name="postProcess">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do before running assemble. -->
    <!-- ===================================================================== -->
    <target name="preAssemble">
        <antcall target="buildHelpSearchDb" />
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do after running assemble. -->
    <!-- ===================================================================== -->
    <target name="postAssemble">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do before running package. -->
    <!-- ===================================================================== -->
    <target name="prePackage">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do after running package. -->
    <!-- ===================================================================== -->
    <target name="postPackage">
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do after the build is done. -->
    <!-- ===================================================================== -->
    <target name="postBuild">
        <antcall target="gatherLogs" />
        <antcall target="test" />
        <antcall target="javadoc" />
        <antcall target="packageProduct" />
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do to build the help search database. -->
    <!-- ===================================================================== -->
    <target name="buildHelpSearchDb">
        <java
                dir="${buildDirectory}/plugins/org.gamegineer.common.ui/help"
                failonerror="true"
                fork="true"
                jar="${gamegineer-java-help-home}/bin/jhindexer.jar">
            <arg value="topics" />
        </java>
        <java
                dir="${buildDirectory}/plugins/org.gamegineer.table.help/help"
                failonerror="true"
                fork="true"
                jar="${gamegineer-java-help-home}/bin/jhindexer.jar">
            <arg value="topics" />
        </java>
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do to generate Javadocs for the entire workspace. -->
    <!-- ===================================================================== -->
    <target name="javadoc">
        <javadoc
                access="private"
                author="true"
                bottom="Copyright 2008-2013 Gamegineer contributors and others.  All rights reserved."
                destdir="${buildDirectory}/${buildLabel}/docs/api"
                doctitle="Gamegineer API"
                failonerror="true"
                nodeprecated="false"
                nodeprecatedlist="false"
                noindex="false"
                nonavbar="false"
                notree="false"
                source="1.7"
                splitindex="true"
                use="true"
                version="true"
                windowtitle="Gamegineer API">
            <classpath>
                <fileset dir="${baseLocation}">
                    <include name="plugins/**/*.jar" />
                </fileset>
                <fileset dir="${buildDirectory}">
                    <include name="plugins/**/lib/*.jar" />
                </fileset>
            </classpath>
            <link
                    href="http://docs.oracle.com/javase/7/docs/api/"
                    offline="true"
                    packagelistURL="http://docs.oracle.com/javase/7/docs/api/" />
            <sourcepath>
                <dirset dir="${buildDirectory}">
                    <include name="plugins/**/src" />
                    <exclude name="plugins/*.tests*/src" />
                </dirset>
            </sourcepath>
            <tag
                    description="No Extend"
                    name="noextend" />
            <tag
                    description="No Implement"
                    name="noimplement" />
        </javadoc>
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do to test the build results. -->
    <!-- ===================================================================== -->
    <target name="test">
        <!-- Create test workspace. -->
        <mkdir dir="${buildDirectory}/${buildLabel}/test-workspace" />

        <!-- Unzip Eclipse SDK into workspace. -->
        <unzip src="${gamegineer-eclipse-home}/eclipse-SDK-${eclipseBuildId}-${baseos}-${basews}-${basearch}.zip" dest="${buildDirectory}/${buildLabel}/test-workspace" overwrite="true" />

        <!-- Copy target platform into workspace. -->
        <copy todir="${buildDirectory}/${buildLabel}/test-workspace/eclipse" overwrite="true">
            <fileset dir="${baseLocation}" />
        </copy>

        <!-- Install Eclipse Test Framework into workspace. -->
        <unzip src="${gamegineer-eclipse-test-framework-home}/eclipse-test-framework-${eclipseBuildId}.zip" dest="${buildDirectory}/${buildLabel}/test-workspace/eclipse-test-framework" overwrite="true" />
        <makeurl file="${buildDirectory}/${buildLabel}/test-workspace/eclipse-test-framework" property="p2.repo" validate="false" />
        <ant antfile="genericTargets.xml" dir="${eclipse.pdebuild.scripts}" target="runDirector">
            <property name="p2.director.extraArgs" value="-tag AddETF" />
            <property name="p2.director.installPath" value="${buildDirectory}/${buildLabel}/test-workspace/eclipse" />
            <property name="p2.director.iu" value="org.eclipse.test.feature.group" />
            <property name="p2.director.profile" value="SDKProfile" />
        </ant>

        <!-- Rename eclipse directory to product archive name. -->
        <move todir="${buildDirectory}/${buildLabel}/test-workspace/${archivePrefix}">
            <fileset dir="${buildDirectory}/${buildLabel}/test-workspace/eclipse" />
        </move>

        <!-- Unzip all Gamegineer features into workspace. -->
        <unzip dest="${buildDirectory}/${buildLabel}/test-workspace" overwrite="true">
            <fileset dir="${buildDirectory}/${buildLabel}">
                <include name="*.zip" />
            </fileset>
        </unzip>

        <!-- Run all tests in all Gamegineer test plugins. -->
        <subant>
            <property name="os" value="${baseos}" />
            <property name="ws" value="${basews}" />
            <property name="arch" value="${basearch}" />
            <property name="org.eclipse.test" value="${eclipseTestId}" />
            <property name="junit-stylesheet" value="${buildDirectory}/${buildLabel}/test-workspace/${archivePrefix}/plugins/org.eclipse.test_${eclipseTestId}/JUNIT.XSL" />
            <fileset dir="${buildDirectory}/${buildLabel}/test-workspace/${archivePrefix}/plugins" includes="org.gamegineer.*/test.xml" />
        </subant>

        <!-- Fail the build if any unit test failed. -->
        <concat destfile="${buildDirectory}/${buildLabel}/test-workspace/${archivePrefix}/results/allTestResults.txt">
            <fileset dir="${buildDirectory}/${buildLabel}/test-workspace/${archivePrefix}/results" includes="*.xml" />
            <filterchain>
                <linecontainsregexp>
                    <regexp pattern="(errors|failures)=&quot;[1-9][0-9]*&quot;" />
                </linecontainsregexp>
            </filterchain>
        </concat>
        <fail message="One or more unit tests failed.">
            <condition>
                <length file="${buildDirectory}/${buildLabel}/test-workspace/${archivePrefix}/results/allTestResults.txt" when="greater" length="0" /> 
            </condition>
        </fail>
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do to package the build results. -->
    <!-- ===================================================================== -->
    <target name="packageProduct">
        <mkdir dir="${buildDirectory}/${buildLabel}/artifacts" />
        <mkdir dir="${buildDirectory}/${buildLabel}/product" />

        <!--
        Copy target platform.  Do not include test-related bundles.  The Equinox
        launcher must be at the root.
        -->
        <copy todir="${buildDirectory}/${buildLabel}/product/${archivePrefix}">
            <fileset dir="${baseLocation}">
                <exclude name="plugins/easymock-*.jar" />
                <exclude name="plugins/org.hamcrest.core_*.jar" />
                <exclude name="plugins/org.junit_*/**" />
                <exclude name="plugins/org.junit4_*/**" />
                <exclude name="plugins/org.eclipse.equinox.launcher_*.jar" />
            </fileset>
        </copy>
        <copy flatten="true" todir="${buildDirectory}/${buildLabel}/product/${archivePrefix}">
            <fileset dir="${baseLocation}">
                <include name="plugins/org.eclipse.equinox.launcher_*.jar" /> 
            </fileset>
        </copy>

        <!-- Copy product configuration. -->
        <copy todir="${buildDirectory}/${buildLabel}/product/${archivePrefix}">
            <fileset dir="${buildDirectory}/product" />
        </copy>

        <!-- Copy all Gamegineer features.  Do not include test-related features. -->
        <unzip dest="${buildDirectory}/${buildLabel}/product" overwrite="true">
            <fileset dir="${buildDirectory}/${buildLabel}">
                <include name="*.zip" />
                <exclude name="*.test.*.zip" />
                <exclude name="*.tests-*.zip" />
            </fileset>
        </unzip>

        <!-- Create product archive. -->
        <zip destfile="${buildDirectory}/${buildLabel}/artifacts/${archivePrefix}-${buildVersion}.zip">
            <fileset dir="${buildDirectory}/${buildLabel}/product" />
        </zip>
    </target>

    <!-- ===================================================================== -->
    <!-- Steps to do to publish the build results. -->
    <!-- ===================================================================== -->
    <target name="publish">
    </target>

    <!-- ===================================================================== -->
    <!-- Default target. -->
    <!-- ===================================================================== -->
    <target name="noDefault">
        <echo message="You must specify a target when invoking this file" />
    </target>

</project>
